---
title: scRNA-Seq Analysis
author: i2dash team
output:
  flexdashboard::flex_dashboard:
    theme: yeti
#runtime: shiny
---
<!-- This dashboard was created with the R package 'i2dash'. https://gitlab.gwdg.de/loosolab/software/i2dash -->
```{r i2dash-global-setup}
# Deal with operation within a switchr environment
if (any(grepl(pattern = ".switchr", x = .libPaths()))) {
  switchr::switchrNoUnload(TRUE)
}

# Make it possible to reuse chunk labels
options(knitr.duplicate.label = "allow")

# Set datadir variable, components should fetch their env from here!
datadir <- "/datadir"
```

Bubbleplot 
====================================================

<!-- Page created on 2019-09-26 16:38:53 -->


Column {.tabset}
----------------------------------------------------


### Test of the bubbleplot

<!-- Component created on 2019-09-26 16:38:46 -->

```{r}
env_eowq8S <- readRDS(file.path(datadir, "env_eowq8S.rds"))
is_shiny <- identical(knitr::opts_knit$get("rmarkdown.runtime"), "shiny")
library(magrittr)
```

```{r, eval=!is_shiny}
# set variables 
# the first column is always used
if(!is.null(env_eowq8S$x_title)) x_title_env_eowq8S <- env_eowq8S$x_title else x_title_env_eowq8S <- colnames(env_eowq8S$x)[1]
if(!is.null(env_eowq8S$y_title)) y_title_env_eowq8S <- env_eowq8S$y_title else y_title_env_eowq8S <- colnames(env_eowq8S$y)[1]
if(!is.null(env_eowq8S$colour_by)) colour_by_env_eowq8S <- env_eowq8S$colour_by[,1] else colour_by_env_eowq8S <- NULL
if(!is.null(env_eowq8S$labels)) labels_env_eowq8S <- env_eowq8S$labels else labels_env_eowq8S <- rownames(env_eowq8S$x)

# creating the plot object
plot_env_eowq8S <- i2dash.scrnaseq::plotly_bubbleplot(x = env_eowq8S$x[,1], y = env_eowq8S$y[,1], size = env_eowq8S$size[,1], color = colour_by_env_eowq8S, text = labels_env_eowq8S, y_title = y_title_env_eowq8S, x_title = x_title_env_eowq8S)

# Provide data for download
if(is.null(env_eowq8S$colour_by)){
  df_env_eowq8S <- data.frame(x = env_eowq8S$x[,1], y = env_eowq8S$y[,1], size = env_eowq8S$size[,1])
} else {
  df_env_eowq8S <- data.frame(x = env_eowq8S$x[,1], y = env_eowq8S$y[,1], size = env_eowq8S$size[,1], colour_by = env_eowq8S$colour_by[,1])
}
htmltools::div(style='display:block;float:left;width:100%;height:90%;',
  htmltools::tags$button(i2dash::embed_var(df_env_eowq8S)), plot_env_eowq8S)
```

```{r, eval=is_shiny}
#
# shiny input widgets
#
ui_list <- list()

# shiny input widget for x
if (ncol(env_eowq8S$x) > 1){
  ui_list <- rlist::list.append(ui_list,
                                selectInput("input_x_env_eowq8S", label = "Select data for x axis:",
                                            choices = colnames(env_eowq8S$x)))
}

# shiny input widget for y
if (ncol(env_eowq8S$y) > 1){
  ui_list <- rlist::list.append(ui_list,
                                selectInput("input_y_env_eowq8S", label = "Select data for y axis:",
                                            choices = colnames(env_eowq8S$y)))
}

# shiny input widget for size
if (ncol(env_eowq8S$size) > 1){
  ui_list <- rlist::list.append(ui_list,
                                selectInput("input_size_env_eowq8S", label = "Select data for the size factor:",
                                            choices = colnames(env_eowq8S$size)))
}

# shiny input widget for colour_by
if (!is.null(env_eowq8S$colour_by)){
  if(ncol(env_eowq8S$colour_by) > 1)
  ui_list <- rlist::list.append(ui_list,
                                selectInput("input_colour_env_eowq8S", label = "Select metadata for colouring:",
                                            choices = colnames(env_eowq8S$colour_by)))
}

#
# shiny download button
#
ui_list <- rlist::list.append(ui_list, tags$div(tags$br(), downloadButton('downloadData_env_eowq8S', 'Download data')))

#
# Handle inputs
#
x_env_eowq8S <- shiny::reactive({
  if(ncol(env_eowq8S$x) == 1){
    data <- env_eowq8S$x[[1]]
    title <- colnames(env_eowq8S$x)[1]
    return(list(data = data, title = title))
  } else {
    data <- env_eowq8S$x[[input$input_x_env_eowq8S]]
    title <- input$input_x_env_eowq8S
    return(list(data = data, title = title))
  }
})

y_env_eowq8S <- shiny::reactive({
  if(ncol(env_eowq8S$y) == 1){
    data <- env_eowq8S$y[[1]]
    title <- colnames(env_eowq8S$y)[1]
    return(list(data = data, title = title))
  } else {
    data <- env_eowq8S$y[[input$input_y_env_eowq8S]]
    title <- input$input_y_env_eowq8S
    return(list(data = data, title = title))
  }
})

size_env_eowq8S <- shiny::reactive({
  if(ncol(env_eowq8S$size) == 1){
    return(data <- env_eowq8S$size[[1]])
  } else {
    return(env_eowq8S$size[[input$input_size_env_eowq8S]])
  }
})

colour_env_eowq8S <- shiny::reactive({
  if(!is.null(env_eowq8S$colour_by)){
    if(ncol(env_eowq8S$colour_by) == 1){
      return(env_eowq8S$colour_by[[1]])
    } else {
      return(env_eowq8S$colour_by[[input$input_colour_env_eowq8S]])
    }
  } else {
    return(NULL)
  }
})

#
# Download data.frame
#
output$downloadData_env_eowq8S <- downloadHandler(
  filename =  paste('data-', Sys.Date(), '.csv', sep=''),
  content = function(file) {
    if(is.null(colour_env_eowq8S()$colour)){
      df <- data.frame(x = x_env_eowq8S()$data, y = y_env_eowq8S()$data, size = size_env_eowq8S())
    } else {
      df <- data.frame(x = x_env_eowq8S()$data, y = y_env_eowq8S()$data, size = size_env_eowq8S(), colour_by = colour_env_eowq8S()$colour)
    }
    write.csv(df, file)
  }
)

#
# reactive for plot creation
#
output$plot_env_eowq8S <- plotly::renderPlotly({
  if(!is.null(env_eowq8S$y_title)) y_title <- env_eowq8S$y_title else y_title <- y_env_eowq8S()$title
  if(!is.null(env_eowq8S$x_title)) x_title <- env_eowq8S$x_title else x_title <- x_env_eowq8S()$title
  if(!is.null(env_eowq8S$labels)) labels <- env_eowq8S$labels else labels <- rownames(env_eowq8S$x)

  i2dash.scrnaseq::plotly_bubbleplot(x = x_env_eowq8S()$data, y = y_env_eowq8S()$data, size = size_env_eowq8S(), color = colour_env_eowq8S(), text = paste0("label: ",labels, "</br>size: ",size_env_eowq8S()), y_title = y_title, x_title = x_title)
  
  
})

#
# Layout of component
#
shiny::fillRow(flex = c(NA, 1),
      shinyWidgets::dropdownButton(div(style='max-height: 350px; overflow-x: auto;',do.call(shiny::inputPanel, ui_list)),
                       circle = TRUE, status = "danger", icon = icon("gear"), width = "300px",
                       tooltip = shinyWidgets::tooltipOptions(title = "Click, to change plot settings:"))
      ,
      plotly::plotlyOutput("plot_env_eowq8S", height = "100%")
)
```

