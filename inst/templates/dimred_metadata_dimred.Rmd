    
### 

<!-- Component created on 2019-08-08 15:09:49 -->

```{r}
{{ env_id }} = readRDS(file.path(datadir, "{{ env_id }}.rds"))

is_shiny <- identical(knitr::opts_knit$get("rmarkdown.runtime"), "shiny")

library(magrittr)

reduced_dim_{{ env_id }} <- {{ env_id }}$reduced_dim
count_table_{{ env_id }} <- {{ env_id }}$expression
metadata_{{ env_id }} <- {{ env_id }}$metadata
featurenames <- row.names(count_table_{{ env_id }})

row.names(metadata_{{ env_id }}) <- c()
string_counts_{{ env_id }} <- apply(count_table_{{ env_id }}, 1, paste0, collapse = ";")
df_couns_stats_{{ env_id }} <- cbind("expressions" = string_counts_{{ env_id }}, "featurenames" = featurenames, metadata_{{ env_id }})
row.names(df_couns_stats_{{ env_id }}) <- c()
```

```{r, eval=!is_shiny}
reduced_dim_{{ env_id }} %>%
  plotly::plot_ly(x = ~x , y= ~y, hoverinfo = "x+y+text", text = row.names(reduced_dim_{{ env_id }}), colors = "YlOrRd", color = count_table_{{ env_id }}[1,], type = "scattergl") %>% 
  plotly::layout(
    title = row.names(count_table_{{ env_id }})[1],
    xaxis = list(title = "Dimension 1"),
    yaxis = list(title = "Dimension 2")
  ) -> plot_{{ env_id }}
plot_{{ env_id }}$elementId <- "plot_{{ env_id }}"

htmltools::div(style="display:block;float:left;width:100%;height:90%;", 
               htmltools::div(
                 htmltools::tags$button(style="display:inline-block;", i2dash::embed_var(reduced_dim_{{ env_id }})),
                 htmltools::HTML("<p style='display:inline-block;'>Please select a feature in the left table to show its expression values.</p>")), plot_{{ env_id }}
)
```

```{r, eval=is_shiny}
ui_list <- list()

#
# Create reactive data table
#
df_{{ env_id }} <- shiny::reactive({
  selected_gene <- input$tbl_{{ env_id }}_row_last_clicked
  if(is.null(selected_gene)){
    expression <- count_table_{{ env_id }}[1,] 
    featurename <- row.names(count_table_{{ env_id }})[1]
  } else {
    expression <- count_table_{{ env_id }}[selected_gene,]
    featurename <- row.names(count_table_{{ env_id }})[selected_gene]
  }

  df <- data.frame("x" = reduced_dim_{{ env_id }}[,1], "y" = reduced_dim_{{ env_id }}[,2], "label" = row.names(reduced_dim_{{ env_id }}), "expression" = expression)
  
  return(list("df" = df, "feature" = featurename))
})

# Download link
ui_list <- rlist::list.append(ui_list, tags$div(tags$br(), downloadButton('downloadData_{{ env_id }}', 'Download data')))

#
# Download
#
output$downloadData_{{ env_id }}<- downloadHandler(
  filename =  paste('data-', Sys.Date(), '.csv', sep=''),
  content = function(file) {
    write.csv(df_{{ env_id }}()$df, file)
  }
)

#
# Output
#
output$plot_scatter_{{ env_id }} <- plotly::renderPlotly({
  df_{{ env_id }}()$df %>% 
    plotly::plot_ly(x = ~x, y = ~y, hoverinfo = "x+y+text", text = ~label, colors = "YlOrRd", color = ~expression) %>%
  plotly::layout(
    title = df_{{ env_id }}()$feature,
    xaxis = list(title = "Dimension 1"),
    yaxis = list(title = "Dimension 2")
  ) -> scatter
  scatter
})

#
# Layout of component
#
shiny::fillRow(flex = c(NA, 1),
      shinyWidgets::dropdownButton(div(style='max-height: 350px; overflow-x: auto;',do.call(shiny::inputPanel, ui_list)),
                       circle = TRUE, status = "danger", icon = icon("gear"), width = "300px",
                       tooltip = shinyWidgets::tooltipOptions(title = "Click, to change plot settings:")),
      htmltools::div(style="display:block;float:left;width:100%;height:85%;padding-left:15px", htmltools::HTML("<p>Please select a feature in the left table to show its expression values.</p>"), plotly::plotlyOutput("plot_scatter_{{ env_id }}", height = "100%"))
)
```

