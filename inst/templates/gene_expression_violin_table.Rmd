###

<!-- Component created on {{ date }} -->

```{r, eval=!is_shiny}
violins <- plotly::plot_ly(ct_{{ env_id }}, colors = "Set1", x = ~level, y = ~expression, color = ~level, type = "violin", box = list(visible = T), meanline = list(visible = T), points = "all", jitter = 0) %>%
    plotly::layout(
      xaxis = list(title = group_filter_{{ env_id }}),
      yaxis = list(title = "Expression per cluster"),
      showlegend = FALSE
    )
violins  %>% plotly::highlight(on = "plotly_selected", dynamic = F, selectize = F)
```

```{r, eval=is_shiny}
df2_{{ env_id }} <- shiny::reactive({
  keys <- plotly::event_data("plotly_selected", source = "scatter_{{ env_id }}")$key
  if(!is.null(keys)) {
    return(df_{{ env_id }}()[keys, ])
  } 
  return(df_{{ env_id }}())
})

output$plot_violin_{{ env_id }} <- plotly::renderPlotly({
  violins <- plotly::plot_ly(df2_{{ env_id }}(), colors = "Set1", x = ~level, y = ~expression, color = ~level, type = "violin", box = list(visible = T), meanline = list(visible = T), points = "all", jitter = 0) %>%
    plotly::layout(
      xaxis = list(title = df_{{ env_id }}()$group_by),
      yaxis = list(title = "Expression"),
      showlegend = FALSE)
})
plotly::plotlyOutput("plot_violin_{{ env_id }}", height = "100%")
```

### No. of cells with positive expression (>0) {data-height=300}

```{r, eval=!is_shiny}
data_{{ env_id }} %>%
  dplyr::filter(group_by == !!group_filter_{{ env_id }}) %>%
  dplyr::group_by(level, feature) %>%
  dplyr::mutate(is_non_zero_exprs = expression > 0) %>%
  dplyr::summarise(n_samples = n(), n_nonzero = sum(is_non_zero_exprs)) %>%
  dplyr::mutate(freq = round(n_nonzero / n_samples * 100, 2)) %>%
  dplyr::mutate(info = paste0(n_nonzero, " / ", n_samples, " (", freq, "%)")) %>%
  dplyr::select(level, feature, info) %>%
  tidyr::spread(level, info) %>%
  DT::datatable()
```

```{r, eval=is_shiny}
df_table_{{ env_id }} <- shiny::reactive({
  selected_group <- input$select_grouping_{{ env_id }}

  data_{{ env_id }} %>%
    dplyr::filter(group_by == !!selected_group) 
})

renderTable({
  df_table_{{ env_id }}() %>%
    dplyr::group_by(level, feature) %>%
    dplyr::mutate(is_non_zero_exprs = expression > 0) %>%
    dplyr::summarise(n_samples = n(), n_nonzero = sum(is_non_zero_exprs)) %>%
    dplyr::mutate(freq = round(n_nonzero / n_samples * 100, 2)) %>%
    dplyr::mutate(info = paste0(n_nonzero, " / ", n_samples, " (", freq, "%)")) %>%
    dplyr::select(level, feature, info) %>%
    tidyr::spread(level, info)
})
```
