
### {{ title }}

<!-- Component created on {{ date }} -->

```{r}
{{ env_id }} = readRDS("envs/{{ env_id }}.rds")

is_shiny <- identical(knitr::opts_knit$get("rmarkdown.runtime"), "shiny")
```

```{r, eval=!is_shiny}
# set variables
y <- {{ env_id }}$y[1]
group_by <- {{ env_id }}$group_by[1]
if(is.null(group_by)){
  df <- data.frame(y)
} else {
  df <- data.frame(y, group_by)
}

# Provide data download
i2dash::embed_var(df)

# Render plot
i2dash.scrnaseq::plotly_violinplot(df = df, group_by = {{ env_id }}$group_by, title_y = {{ env_id }}$title_y, title_group_by = {{ env_id }}$title_group_by)
```

```{r, eval=is_shiny}
ui_list <- list()

# selection field for y
if ({{ env_id }}$y_selection){
  ui_list <- rlist::list.append(ui_list,
                                selectInput("select_y_{{ env_id }}", label = "Select observations:",
                                            choices = names({{ env_id }}$y)))
}

# selection field for group_by
if ({{ env_id }}$y_selection){
  ui_list <- rlist::list.append(ui_list,
                                selectInput("select_group_by_{{ env_id }}", label = "Group observations by:",
                                            choices = names({{ env_id }}$group_by)))
}

# download_link
ui_list <- rlist::list.append(ui_list, tags$div(tags$br(), downloadButton('downloadData_{{ env_id }}', 'Download data')))

#
# Create reactive dataframe
#
df_{{ env_id }} <- shiny::reactive({
  
  if( !{{ env_id }}$y_selection ) {
    y <- {{ env_id }}$y[1]
  } else {
    y <- {{ env_id }}$y[input$select_y_{{ env_id }}]
  }

  if( !{{ env_id }}$group_by_selection ) {
    group_by <- {{ env_id }}$group_by[1]
  } else {
    group_by <- {{ env_id }}$group_by[input$select_group_by_{{ env_id }}]
  }

  if(is.null(group_by)){
    df <- data.frame(y)
  } else {
    df <- data.frame(y, group_by)
  }
  #print(head(df))
  return(df)
  })

#
# Download
#
output$downloadData_{{ env_id }} <- downloadHandler(
  filename =  paste('data-', Sys.Date(), '.csv', sep=''),
  content = function(file) {
    write.csv(df_{{ env_id }}(), file)
  }
)

#
# Output
#
output$plot_{{ env_id }} <- plotly::renderPlotly(
  i2dash.scrnaseq::plotly_violinplot(df = df_{{ env_id }}(), group_by = {{ env_id }}$group_by, title_y = {{ env_id }}$title_y, title_group_by = {{ env_id }}$title_group_by)
)

shiny::fillCol(flex = c(NA, 1),
        do.call(shiny::inputPanel, ui_list),
        plotly::plotlyOutput("plot_{{ env_id }}", height = "100%")
)
```

