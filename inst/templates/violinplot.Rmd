
### {{ title }}

<!-- Component created on {{ date }} -->

```{r}
{{ env_id }} = readRDS("envs/{{ env_id }}.rds")

is_shiny <- identical(knitr::opts_knit$get("rmarkdown.runtime"), "shiny")
```

```{r, eval=!is_shiny}
# Function to create a dataframe for bar plot
output_list <- i2dash.scrnaseq::create_violinplot_df(y = {{ env_id }}$y[1], group_by = {{ env_id }}$group_by[1], title_y = {{ env_id }}$title_y, title_group_by = {{ env_id }}$title_group_by)

# Provide data download
i2dash::embed_var(output_list$df)

# Render plot
i2dash.scrnaseq::plotly_violinplot(x = output_list$x, y = output_list$y, split = output_list$split, showlegend = output_list$showlegend, title_y = output_list$title_y, title_group_by = output_list$title_group_by)
```

```{r, eval=is_shiny}
ui_list <- list()

# selection field for y
if ({{ env_id }}$y_selection){
  ui_list <- rlist::list.append(ui_list,
                                selectInput("select_y_{{ env_id }}", label = "Select observations:",
                                            choices = names({{ env_id }}$y)))
}

# selection field for group_by
if ({{ env_id }}$group_by_selection){
  ui_list <- rlist::list.append(ui_list,
                                selectInput("select_group_by_{{ env_id }}", label = "Group observations by:",
                                            choices = names({{ env_id }}$group_by)))
}

# download_link
ui_list <- rlist::list.append(ui_list, tags$div(tags$br(), downloadButton('downloadData_{{ env_id }}', 'Download data')))

#
# Create reactive method
#
df_{{ env_id }} <- shiny::reactive({
  
  if( !{{ env_id }}$y_selection ) {
    y <- {{ env_id }}$y[1]
  } else {
    y <- {{ env_id }}$y[input$select_y_{{ env_id }}]
  }

  if( !{{ env_id }}$group_by_selection ) {
    group_by <- {{ env_id }}$group_by[1]
  } else {
    group_by <- {{ env_id }}$group_by[input$select_group_by_{{ env_id }}]
  }
  
  return(i2dash.scrnaseq::create_violinplot_df(y = y, group_by = group_by, title_y = {{ env_id }}$title_y, title_group_by = {{ env_id }}$title_group_by))
})

#
# Download
#
output$downloadData_{{ env_id }} <- downloadHandler(
  filename =  paste('data-', Sys.Date(), '.csv', sep=''),
  content = function(file) {
    write.csv(df_{{ env_id }}()$df, file)
  }
)

#
# Output
#
output$plot_{{ env_id }} <- plotly::renderPlotly(
  i2dash.scrnaseq::plotly_violinplot(x = df_{{ env_id }}()$x, y = df_{{ env_id }}()$y, split = df_{{ env_id }}()$split, showlegend = df_{{ env_id }}()$showlegend, title_y = df_{{ env_id }}()$title_y, title_group_by = df_{{ env_id }}()$title_group_by)
)

#
# Layout of component junk
#
shiny::fillCol(flex = c(NA, 1),
        do.call(shiny::inputPanel, ui_list),
        plotly::plotlyOutput("plot_{{ env_id }}", height = "100%")
)
```


