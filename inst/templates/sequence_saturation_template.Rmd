
### {{ title }}

<!-- Component created on {{ date }} -->

```{r}
{{ env_id }} = readRDS(file.path(datadir, "{{ env_id }}.rds"))

is_shiny <- identical(knitr::opts_knit$get("rmarkdown.runtime"), "shiny")
```

```{r, eval=!is_shiny}

# x_value <- {{ env_id }}$x[[1]]
# x_title <- names({{ env_id }}$x[1])
# 
# y_value <- {{ env_id }}$y[[1]]
# y_title <- names({{ env_id }}$y[1])

# Create data.frame for download
df_list <- list()
if (!is.null({{ env_id }}$labels)) df_list <- rlist::list.append(df_list, {{ env_id }}$labels)
df_list <- rlist::list.append(df_list, c({{ env_id }}$x, {{ env_id }}$y))
if (!is.null({{ env_id }}$colour_by)) df_list <- rlist::list.append(df_list, {{ env_id }}$colour_by)
df <- do.call("data.frame", df_list)

# download_link
i2dash::embed_var(df)

# set variables
x <- {{ env_id }}$x[1]
y <- {{ env_id }}$y[1]

if (!is.null({{ env_id }}$colour_by)){
  colour_by <- {{ env_id }}$colour_by[1]
} else {
  colour_by <- NULL
}

################## Test scatter_plot funktion - funktioniert #######################
p <- i2dash.scrnaseq::.scatter_plot(labels = {{ env_id }}$labels, x = x, y = y, colour_by = colour_by)
p
```

```{r, eval=is_shiny}

ui_list <- list()

# selection field for x
if ({{ env_id }}$x_selection){
  ui_list <- rlist::list.append(ui_list,
  selectInput("select_x_{{ env_id }}", label = "Select data for x axis:",
              choices = names({{ env_id }}$x)))
}

# selection field for y
if ({{ env_id }}$y_selection){
  ui_list <- rlist::list.append(ui_list,
  selectInput("select_y_{{ env_id }}", label = "Select data for y axis:",
              choices = names({{ env_id }}$y)))
}

# selection field for colour_by
if ({{ env_id }}$colour_by_selection){
  ui_list <- rlist::list.append(ui_list,
  selectInput("select_colour_{{ env_id }}", label = "Select colouring:",
              choices = names({{ env_id }}$colour_by)))
}

# Checkbox and selection field for colour by sample name
if (!is.null({{ env_id }}$labels)) {
  ui_list <- rlist::list.append(ui_list,
                                tags$div(checkboxInput("checkbox_{{ env_id }}", label = "Colour by sample name", value = FALSE),
                                        selectInput("select_name_{{ env_id }}", label = NULL, choices = {{ env_id }}$labels)
  ))
}

# Create data.frame for download
df_list <- list()
if (!is.null({{ env_id }}$labels)) df_list <- rlist::list.append(df_list, {{ env_id }}$labels)
df_list <- rlist::list.append(df_list, c({{ env_id }}$x, {{ env_id }}$y))
if (!is.null({{ env_id }}$colour_by)) df_list <- rlist::list.append(df_list, {{ env_id }}$colour_by)
df <- do.call("data.frame", df_list)

# download_link
ui_list <- rlist::list.append(ui_list, i2dash::embed_var(df))

fillCol(flex = c(NA, 1),
        do.call("inputPanel", ui_list),
        plotly::plotlyOutput("plot_{{ env_id }}", height = "100%")
        )

output$plot_{{ env_id }} <- plotly::renderPlotly({
  # set variables
  if (!{{ env_id }}$x_selection) x <- {{ env_id }}$x[1] else x <- {{ env_id }}$x[input$select_x_{{ env_id }}]
  if (!{{ env_id }}$y_selection) y <- {{ env_id }}$y[1] else y <- {{ env_id }}$y[input$select_y_{{ env_id }}]

  if (!{{ env_id }}$colour_by_selection){
    if (!is.null({{ env_id }}$colour_by)){
      colour_by <- {{ env_id }}$colour_by[1]
    } else {
      colour_by <- NULL
      }
  } else {
    colour_by <- {{ env_id }}$colour_by[input$select_colour_{{ env_id }}]
  }

  ################## Test scatter_plot funktion - funktioniert #######################
  p <- i2dash.scrnaseq::.scatter_plot(labels = {{ env_id }}$labels, x = x, y = y, colour_by = colour_by, checkbox = input$checkbox_{{ env_id }}, selected_label = input$select_name_{{ env_id }})
  p
})  

###################### Funktionierende Variante ohne scatter_plot Funktion ############
#   
#   # create data.frame for plot
#   plot_list <- list()
#   if (!is.null({{ env_id }}$labels)) plot_list <- rlist::list.append(plot_list, {{ env_id }}$labels) else plot_list <- rlist::list.append(plot_list, c(1:length(x[[1]])))
#   plot_list <- rlist::list.append(plot_list, c(x, y))
#   if (!is.null({{ env_id }}$colour_by)) plot_list <- rlist::list.append(plot_list, colour_by) else plot_list <- rlist::list.append(plot_list, c(1:length(x[[1]])))
#   plot_df <- do.call("data.frame", plot_list)
# 
#   labels <- plot_df[[1]]
#   x_value <- plot_df[[2]]
#   y_value <- plot_df[[3]]
#   colour_by <- plot_df[[4]]
# 
#   x_title <- names(plot_df[[2]])
#   y_title <- names(plot_df[[3]])
# 
#   if(is.null({{ env_id }}$labels)) {
#     labels <- NULL
#   }
#   if(is.null({{ env_id }}$colour_by)) {
#     colour_by <- NULL
#   }
#   #find point for annotation
#   a <- NULL
#   if (!is.null({{ env_id }}$labels)) {
#     if (input$checkbox_{{ env_id }}) {
#       colour_by <- NULL
#       point_index <- match(input$select_name_{{ env_id }}, plot_df[[1]])
#       point <- plot_df[point_index,]
#       a <- list(
#         x = point[,2],
#         y = point[,3],
#         text = point[,1],
#         xref = "x",
#         yref = "y",
#         showarrow = T,
#         arrowhead = 7,
#         arrowcolor = "red",
#         ax = 20,
#         ay = -40
#       )
#     }
#   }
#   
#   # plotly
#   p <- plotly::plot_ly(plot_df,
#                x = x_value,
#                y = y_value,
#                color = colour_by,
#                text = labels
#   )
#   p <- plotly::add_markers(p)
#   p <- plotly::layout(p,
#               xaxis = list(title = x_title),
#               yaxis = list(title = y_title),
#               annotations = a)
#   p
# })
```

***

Plot description:

Sequencing is called *saturated* when generating more sequencing output from a cDNA library does not substantially increase the number of detected features in a sample. Since the number of detected features can act as a technical confounder, and thereby drive substructure in the data, it is advisable to aim for a saturated sequencing by either adding more sequencing output or decreasing the number of samples until saturation is achieved. [@zhang_one_2018] gives advise on how to choose the optimal cell number given a fixed sequencing budget


