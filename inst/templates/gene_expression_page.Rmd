### 

<!-- Component created on {{ date }} -->

```{r}
{{ env_id }} = readRDS(file.path(datadir, "{{ env_id }}.rds"))

is_shiny <- identical(knitr::opts_knit$get("rmarkdown.runtime"), "shiny")

library(dplyr)
library(magrittr)

data_{{ env_id }} <- {{ env_id }}$data
group_filter_{{ env_id }} <- {{ env_id }}$group_filter
```

```{r, eval=!is_shiny}
# Create shared crosstalk object
data_{{ env_id }} %>%
  dplyr::filter(group_by == !!group_filter_{{ env_id }}) %>%
  plotly::highlight_key() -> ct_{{ env_id }}

ct_{{ env_id }} %>%
  plotly::plot_ly(colors = "Set1", color = ~level) %>%
  plotly::group_by(level) %>%
  plotly::add_markers(x = ~x, y = ~y, hoverinfo = "x+y+text", text = ~paste(label, "<br />Group: ", level), type = "scattergl") %>%
  plotly::layout(
    xaxis = list(title = "Dimension 1"),
    yaxis = list(title = "Dimension 2"),
    showlegend = FALSE
  ) %>% plotly::highlight(on = "plotly_selected", dynamic = F, selectize = F) -> base

htmltools::div(style="display:block;float:left;width:100%;height:75%;",
  crosstalk::filter_select("id2", "Select a gene:", ct_{{ env_id }}, ~feature, multiple = F),
  base
  )
```

```{r, eval=is_shiny}
ui_list <- list()

# selection field for grouping
ui_list <- rlist::list.append(ui_list,
                                selectInput("select_grouping_{{ env_id }}", label = "Select column for grouping:",
                                            choices = unique(data_{{ env_id }}$group_by), selected = group_filter_{{ env_id }}))

# selection field for gene
ui_list <- rlist::list.append(ui_list,
                              selectInput("select_feature_{{ env_id }}", label = "Select a feature:",
                                          choices = unique(data_{{ env_id }}$feature)))


# Download link
ui_list <- rlist::list.append(ui_list, tags$div(tags$br(), downloadButton('downloadData_{{ env_id }}', 'Download data')))

#
# Create reactive data table
#
df_{{ env_id }} <- shiny::reactive({
  selected_group <- input$select_grouping_{{ env_id }}
  selected_feature <- input$select_feature_{{ env_id }}

  data_{{ env_id }} %>%
    dplyr::filter(feature == !!selected_feature, group_by == !!selected_group) 
})

#
# Download
#
output$downloadData_{{ env_id }}<- downloadHandler(
  filename =  paste('data-', Sys.Date(), '.csv', sep=''),
  content = function(file) {
    write.csv(df_{{ env_id }}(), file)
  }
)

#
# Output
#
output$plot_scatter_{{ env_id }} <- plotly::renderPlotly({
  df_{{ env_id }}() %>%
    plotly::plot_ly(colors = "Set1", color = ~level, source = "scatter_{{ env_id }}", key = rownames(df_{{ env_id }}())) %>%
    plotly::group_by(level) %>%
    plotly::add_markers(x = ~x, y = ~y, hoverinfo = "x+y+text", text = ~paste(label, "<br />Group: ", level), type = "scattergl") %>%
    plotly::layout(
      xaxis = list(title = "Dimension 1"),
      yaxis = list(title = "Dimension 2"),
      showlegend = FALSE) %>% 
    plotly::event_register("plotly_selected") -> base
  base
})

#
# Layout of component
#
shiny::fillRow(flex = c(NA, 1),
      shinyWidgets::dropdownButton(div(style='max-height: 350px; overflow-x: auto;',do.call(shiny::inputPanel, ui_list)),
                       circle = TRUE, status = "danger", icon = icon("gear"), width = "300px",
                       tooltip = shinyWidgets::tooltipOptions(title = "Click, to change plot settings:")),
      plotly::plotlyOutput("plot_scatter_{{ env_id }}", height = "100%")
)
```

Column
-------------------------------------

###

```{r, eval=!is_shiny}
violins <- plotly::plot_ly(ct_{{ env_id }}, colors = "Set1", x = ~level, y = ~expression, color = ~level, type = "violin", box = list(visible = T), meanline = list(visible = T), points = "all", jitter = 0) %>%
    plotly::layout(
      xaxis = list(title = group_filter_{{ env_id }}),
      yaxis = list(title = "Expression per cluster"),
      showlegend = FALSE
    )
violins  %>% plotly::highlight(on = "plotly_selected", dynamic = F, selectize = F)
```

```{r, eval=is_shiny}
df2_{{ env_id }} <- shiny::reactive({
  keys <- plotly::event_data("plotly_selected", source = "scatter_{{ env_id }}")$key
  if(!is.null(keys)) {
    return(df_{{ env_id }}()[keys, ])
  } 
  return(df_{{ env_id }}())
})

output$plot_violin_{{ env_id }} <- plotly::renderPlotly({
  violins <- plotly::plot_ly(df2_{{ env_id }}(), colors = "Set1", x = ~level, y = ~expression, color = ~level, type = "violin", box = list(visible = T), meanline = list(visible = T), points = "all", jitter = 0) %>%
    plotly::layout(
      xaxis = list(title = df_{{ env_id }}()$group_by),
      yaxis = list(title = "Expression"),
      showlegend = FALSE)
})
plotly::plotlyOutput("plot_violin_{{ env_id }}", height = "100%")
```

### No. of cells with positive expression (>0) {data-height=300}

```{r, eval=!is_shiny}
data_{{ env_id }} %>%
  dplyr::filter(group_by == !!group_filter_{{ env_id }}) %>%
  dplyr::group_by(level, feature) %>%
  dplyr::mutate(is_non_zero_exprs = expression > 0) %>%
  dplyr::summarise(n_samples = n(), n_nonzero = sum(is_non_zero_exprs)) %>%
  dplyr::mutate(freq = round(n_nonzero / n_samples * 100, 2)) %>%
  dplyr::mutate(info = paste0(n_nonzero, " / ", n_samples, " (", freq, "%)")) %>%
  dplyr::select(level, feature, info) %>%
  tidyr::spread(level, info) %>%
  DT::datatable()
```

```{r, eval=is_shiny}
df_table_{{ env_id }} <- shiny::reactive({
  selected_group <- input$select_grouping_{{ env_id }}

  data_{{ env_id }} %>%
    dplyr::filter(group_by == !!selected_group) 
})

renderTable({
  df_table_{{ env_id }}() %>%
    dplyr::group_by(level, feature) %>%
    dplyr::mutate(is_non_zero_exprs = expression > 0) %>%
    dplyr::summarise(n_samples = n(), n_nonzero = sum(is_non_zero_exprs)) %>%
    dplyr::mutate(freq = round(n_nonzero / n_samples * 100, 2)) %>%
    dplyr::mutate(info = paste0(n_nonzero, " / ", n_samples, " (", freq, "%)")) %>%
    dplyr::select(level, feature, info) %>%
    tidyr::spread(level, info)
})
```
